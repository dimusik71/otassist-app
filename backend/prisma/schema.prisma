// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id
  email         String       @unique
  name          String?
  emailVerified Boolean      @default(false)
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]
  Profile       Profile?
  clients       Client[]
  assessments   Assessment[]
  auditLogs     AuditLog[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Profile {
  id                    Int      @id @default(autoincrement())
  handle                String   @unique
  user                  User     @relation(fields: [userId], references: [id])
  userId                String   @unique

  // Professional Registration
  ahpraNumber           String?  // AHPRA registration number
  profession            String?  // "Occupational Therapist", "Physiotherapist", etc.
  registrationExpiry    DateTime?

  // Business Details
  businessName          String?
  abn                   String?  // Australian Business Number
  acn                   String?  // Australian Company Number (if applicable)

  // Contact & Address
  businessPhone         String?
  businessEmail         String?
  businessAddress       String?
  businessSuburb        String?
  businessState         String?
  businessPostcode      String?

  // Rates & Pricing
  defaultHourlyRate     Float?   @default(150)
  assessmentFee         Float?   @default(250)
  reportFee             Float?   @default(180)
  travelRate            Float?   @default(85)

  // Additional Professional Info
  qualifications        String?  // JSON array of qualifications
  specializations       String?  // JSON array of specializations
  yearsExperience       Int?

  // Invoice/Quote Details
  paymentTerms          String?  @default("Payment due within 14 days")
  bankAccountName       String?
  bsb                   String?
  accountNumber         String?

  // Logo & Branding
  logoUrl               String?
  brandColor            String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// OT/AH Assessment App Models

model Client {
  id                String       @id @default(cuid())
  name              String
  email             String?
  phone             String?
  address           String?
  latitude          Float?
  longitude         Float?
  dateOfBirth       DateTime?
  notes             String?

  // Archival and deletion tracking
  isArchived        Boolean      @default(false)
  archivedAt        DateTime?
  deletionReason    String?
  canDeleteAfter    DateTime?    // Calculated based on client age and retention policy
  isChild           Boolean      @default(false) // For 7-year retention calculation

  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  userId            String
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessments       Assessment[]
  documents         Document[]

  @@map("client")
}

model Assessment {
  id                String              @id @default(cuid())
  clientId          String
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessmentType    String              // "home", "assistive_tech", "iot_devices", "general"
  status            String              @default("draft") // "draft", "in_progress", "completed", "approved", "archived"
  location          String?
  latitude          Float?
  longitude         Float?
  assessmentDate    DateTime            @default(now())
  notes             String?
  aiSummary         String?
  reportGenerated   Boolean             @default(false)

  // AI Consent Tracking (APP 6, APP 8 compliance)
  aiConsentGiven    Boolean             @default(false) // Has client consented to AI analysis?
  aiConsentDate     DateTime?           // When consent was given
  aiServicesUsed    String?             // JSON array of AI services used: ["openai", "google", "xai"]

  // Archival and deletion tracking
  isArchived        Boolean             @default(false)
  archivedAt        DateTime?
  deletionReason    String?
  canDeleteAfter    DateTime?           // Calculated based on completion date and retention policy
  completedAt       DateTime?           // Track when assessment was completed for retention calculation

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  media             AssessmentMedia[]
  equipment         AssessmentEquipment[]
  quotes            Quote[]
  invoices          Invoice[]
  responses         AssessmentResponse[]
  houseMap          HouseMap?

  @@map("assessment")
}

model AssessmentResponse {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  questionId   String     // References question ID from assessmentForm.ts
  sectionId    String     // Section this question belongs to
  answer       String?    // Yes/No/Text answer
  notes        String?    // Additional notes from therapist
  mediaUrl     String?    // Photo/video/document URL
  mediaType    String?    // "photo", "video", "document"
  aiAnalysis   String?    // AI feedback on this specific question
  aiSuggestions String?   // AI recommendations
  needsFollowUp Boolean   @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([assessmentId, questionId])
  @@map("assessment_response")
}

model AssessmentMedia {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  type         String     // "photo", "video", "audio"
  url          String
  caption      String?
  aiAnalysis   String?
  createdAt    DateTime   @default(now())

  @@map("assessment_media")
}

model EquipmentItem {
  id                  String              @id @default(cuid())
  name                String
  description         String?
  category            String              // "mobility", "bathroom", "bedroom", "assistive_tech", "iot"
  price               Decimal             @default(0)
  supplierPrice       Decimal?
  margin              Decimal?            // Minimum margin percentage
  brand               String?
  model               String?
  specifications      String?             // JSON string
  governmentApproved  Boolean             @default(false)
  approvalReference   String?
  imageUrl            String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  assessments         AssessmentEquipment[]

  @@map("equipment_item")
}

model AssessmentEquipment {
  id           String        @id @default(cuid())
  assessmentId String
  assessment   Assessment    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  equipmentId  String
  equipment    EquipmentItem @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  quantity     Int           @default(1)
  recommended  Boolean       @default(true)
  priority     String?       // "high", "medium", "low"
  notes        String?
  createdAt    DateTime      @default(now())

  @@map("assessment_equipment")
}

model Quote {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  quoteNumber  String     @unique
  optionName   String     // "Option 1", "Option 2", "Option 3"
  items        String     // JSON string of items
  subtotal     Decimal    @default(0)
  tax          Decimal    @default(0)
  total        Decimal    @default(0)
  notes        String?
  validUntil   DateTime?
  status       String     @default("draft") // "draft", "sent", "accepted", "rejected"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("quote")
}

model Invoice {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  invoiceNumber String    @unique
  items        String     // JSON string of items
  subtotal     Decimal    @default(0)
  tax          Decimal    @default(0)
  total        Decimal    @default(0)
  hourlyRate   Decimal?
  hoursWorked  Decimal?
  status       String     @default("draft") // "draft", "sent", "paid", "overdue"
  dueDate      DateTime?
  paidDate     DateTime?
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("invoice")
}

// 3D House Mapping Models

model HouseMap {
  id           String     @id @default(cuid())
  assessmentId String     @unique
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  propertyType String?    // "single_family", "apartment", "condo", "townhouse"
  totalArea    Decimal?   // Total square footage/meters
  floors       Int        @default(1)
  metadata     String?    // JSON: {buildingYear, style, lotSize, etc}
  aiGenerated  Boolean    @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  rooms        Room[]
  areas        Area[]
  iotDevices   IoTDevicePlacement[]

  @@map("house_map")
}

model Room {
  id          String   @id @default(cuid())
  houseMapId  String
  houseMap    HouseMap @relation(fields: [houseMapId], references: [id], onDelete: Cascade)
  name        String   // "Living Room", "Master Bedroom", etc
  roomType    String   // "bedroom", "bathroom", "kitchen", "living", "dining", "hallway", "entrance", "utility"
  floor       Int      @default(1)
  length      Decimal? // in meters or feet
  width       Decimal? // in meters or feet
  height      Decimal? // ceiling height
  area        Decimal? // calculated or measured
  position3D  String?  // JSON: {x, y, z, rotation} coordinates in 3D space
  features    String?  // JSON: [window positions, door positions, fixtures]
  notes       String?
  photoUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  iotDevices  IoTDevicePlacement[]

  @@map("room")
}

model Area {
  id          String   @id @default(cuid())
  houseMapId  String
  houseMap    HouseMap @relation(fields: [houseMapId], references: [id], onDelete: Cascade)
  name        String   // "Front Patio", "Backyard", "Driveway", "Garage"
  areaType    String   // "outdoor", "garage", "patio", "deck", "yard", "driveway", "pathway"
  length      Decimal?
  width       Decimal?
  area        Decimal?
  position3D  String?  // JSON: {x, y, z, rotation}
  features    String?  // JSON: lighting, surface type, accessibility features
  notes       String?
  photoUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  iotDevices  IoTDevicePlacement[]

  @@map("area")
}

// IoT Device Library and Specifications

model IoTDeviceLibrary {
  id                String   @id @default(cuid())
  name              String
  manufacturer      String?
  model             String?
  category          String   // "safety", "security", "accessibility", "comfort", "health", "lighting", "climate"
  deviceType        String   // "camera", "sensor", "smart_lock", "voice_assistant", "fall_detector", "emergency_button", "smart_light", "thermostat", "door_sensor", "motion_sensor", "smoke_detector", "co_detector", "water_leak_detector", "medication_reminder"
  description       String?
  technicalSpecs    String   // JSON: {connectivity, power, range, compatibility, dimensions, weight, mounting}
  placementRules    String?  // JSON: {idealHeight, minDistance, maxDistance, avoidAreas, requirements}
  coverageArea      Decimal? // Coverage radius/area in meters/feet
  powerRequirements String?  // "battery", "ac_power", "usb", "poe"
  connectivity      String?  // "wifi", "zigbee", "z-wave", "bluetooth", "cellular"
  price             Decimal  @default(0)
  installationCost  Decimal? // Professional installation cost
  subscriptionCost  Decimal? // Monthly SaaS cost
  subscriptionType  String?  // "monthly", "annual", "one_time"
  imageUrl          String?
  documentationUrl  String?
  approvedFor       String?  // JSON: ["ndis", "dva", "insurance"] - government approvals
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  placements        IoTDevicePlacement[]

  @@map("iot_device_library")
}

model IoTDevicePlacement {
  id              String            @id @default(cuid())
  houseMapId      String
  houseMap        HouseMap          @relation(fields: [houseMapId], references: [id], onDelete: Cascade)
  roomId          String?
  room            Room?             @relation(fields: [roomId], references: [id], onDelete: SetNull)
  areaId          String?
  area            Area?             @relation(fields: [areaId], references: [id], onDelete: SetNull)
  deviceId        String
  device          IoTDeviceLibrary  @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  quantity        Int               @default(1)
  position3D      String            // JSON: {x, y, z, rotation, wallMounted, ceilingMounted}
  placementReason String?           // AI-generated explanation for this placement
  priority        String            @default("recommended") // "essential", "recommended", "optional"
  status          String            @default("proposed") // "proposed", "approved", "installed", "rejected"
  installationNotes String?
  aiRecommended   Boolean           @default(false)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("iot_device_placement")
}

// Document Management System
// Stores all generated documents (invoices, quotes, reports, maps, assessments)
model Document {
  id              String     @id @default(cuid())
  clientId        String
  client          Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  assessmentId    String?    // Optional link to specific assessment
  documentType    String     // "invoice", "quote", "report", "house_map", "assessment_summary"
  title           String     // Human-readable title
  content         String     // JSON content of the document
  format          String     @default("json") // "json", "pdf", "html"
  metadata        String?    // JSON: {invoiceNumber, quoteNumber, generatedBy, etc}
  fileUrl         String?    // URL if exported as file
  status          String     @default("draft") // "draft", "final", "archived"
  version         Int        @default(1)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([clientId, documentType])
  @@index([assessmentId])
  @@map("document")
}

// Audit Log for Healthcare Compliance (APP 11, APP 13)
// Tracks all access to sensitive patient data for compliance and breach investigation
model AuditLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action      String   // "client_view", "assessment_view", "ai_analysis", "file_upload", "data_export"
  resource    String?  // "client:123", "assessment:456"
  details     String?  // JSON with additional context
  thirdParty  String?  // "openai", "google", "xai" - when data sent to external services
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())

  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@map("audit_log")
}

