// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String       @id
  email         String       @unique
  name          String?
  emailVerified Boolean      @default(false)
  image         String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]
  Profile       Profile?
  clients       Client[]
  assessments   Assessment[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Profile {
  id     Int    @id @default(autoincrement())
  handle String @unique
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

// OT/AH Assessment App Models

model Client {
  id          String       @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  dateOfBirth DateTime?
  notes       String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessments Assessment[]

  @@map("client")
}

model Assessment {
  id                String              @id @default(cuid())
  clientId          String
  client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  userId            String
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  assessmentType    String              // "home", "assistive_tech", "general"
  status            String              @default("draft") // "draft", "in_progress", "completed", "approved"
  location          String?
  assessmentDate    DateTime            @default(now())
  notes             String?
  aiSummary         String?
  reportGenerated   Boolean             @default(false)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  media             AssessmentMedia[]
  equipment         AssessmentEquipment[]
  quotes            Quote[]
  invoices          Invoice[]
  responses         AssessmentResponse[]

  @@map("assessment")
}

model AssessmentResponse {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  questionId   String     // References question ID from assessmentForm.ts
  sectionId    String     // Section this question belongs to
  answer       String?    // Yes/No/Text answer
  notes        String?    // Additional notes from therapist
  mediaUrl     String?    // Photo/video/document URL
  mediaType    String?    // "photo", "video", "document"
  aiAnalysis   String?    // AI feedback on this specific question
  aiSuggestions String?   // AI recommendations
  needsFollowUp Boolean   @default(false)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([assessmentId, questionId])
  @@map("assessment_response")
}

model AssessmentMedia {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  type         String     // "photo", "video", "audio"
  url          String
  caption      String?
  aiAnalysis   String?
  createdAt    DateTime   @default(now())

  @@map("assessment_media")
}

model EquipmentItem {
  id                  String              @id @default(cuid())
  name                String
  description         String?
  category            String              // "mobility", "bathroom", "bedroom", "assistive_tech", "iot"
  price               Decimal             @default(0)
  supplierPrice       Decimal?
  margin              Decimal?            // Minimum margin percentage
  brand               String?
  model               String?
  specifications      String?             // JSON string
  governmentApproved  Boolean             @default(false)
  approvalReference   String?
  imageUrl            String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  assessments         AssessmentEquipment[]

  @@map("equipment_item")
}

model AssessmentEquipment {
  id           String        @id @default(cuid())
  assessmentId String
  assessment   Assessment    @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  equipmentId  String
  equipment    EquipmentItem @relation(fields: [equipmentId], references: [id], onDelete: Cascade)
  quantity     Int           @default(1)
  recommended  Boolean       @default(true)
  priority     String?       // "high", "medium", "low"
  notes        String?
  createdAt    DateTime      @default(now())

  @@map("assessment_equipment")
}

model Quote {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  quoteNumber  String     @unique
  optionName   String     // "Option 1", "Option 2", "Option 3"
  items        String     // JSON string of items
  subtotal     Decimal    @default(0)
  tax          Decimal    @default(0)
  total        Decimal    @default(0)
  notes        String?
  validUntil   DateTime?
  status       String     @default("draft") // "draft", "sent", "accepted", "rejected"
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("quote")
}

model Invoice {
  id           String     @id @default(cuid())
  assessmentId String
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  invoiceNumber String    @unique
  items        String     // JSON string of items
  subtotal     Decimal    @default(0)
  tax          Decimal    @default(0)
  total        Decimal    @default(0)
  hourlyRate   Decimal?
  hoursWorked  Decimal?
  status       String     @default("draft") // "draft", "sent", "paid", "overdue"
  dueDate      DateTime?
  paidDate     DateTime?
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("invoice")
}
